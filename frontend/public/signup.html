<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>회원가입</title>
    <style>
        :root{
          --max-width: 520px;
          --accent: #2563eb;
          --bg: #f7f9fc;
          --card: #ffffff;
        }
        body{
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
          background: linear-gradient(180deg, var(--bg), #eef4ff);
          display:flex; align-items:center; justify-content:center;
          min-height:100vh; margin:0; padding:24px;
        }
        .card{
          width:100%; max-width:var(--max-width); background:var(--card);
          padding:20px; border-radius:12px; box-shadow:0 6px 30px rgba(16,24,40,0.08);
        }
        h1{ margin:0 0 8px 0; font-size:20px; }
        p.lead{ margin:0 0 18px 0; color:#475569; font-size:14px }
        label{ display:block; font-weight:600; margin-bottom:6px; font-size:13px; }
        .field{ margin-bottom:14px; }
        input[type="text"], input[type="email"], input[type="password"], input[type="file"]{
          width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6eef8; font-size:14px;
          box-sizing:border-box;
        }
        .row{ display:flex; gap:12px; }
        .small { font-size:12px; color:#6b7280; margin-top:6px; }
        .btn{
          background:var(--accent); color:white; padding:10px 14px; border-radius:8px; border:none;
          font-weight:600; cursor:pointer; width:100%;
        }
        .btn[disabled]{ opacity:0.6; cursor:not-allowed; }
        .img-preview{
          display:flex; align-items:center; gap:12px; margin-top:8px;
        }
        .img-preview img{ width:72px; height:72px; object-fit:cover; border-radius:8px; border:1px solid #e6eef8; }
        .pw-strength{ height:8px; background:#e6eef8; border-radius:6px; overflow:hidden; margin-top:6px; }
        .pw-strength > i{ display:block; height:100%; width:0%; transition:width .25s ease; background:linear-gradient(90deg,#f97316,#eab308); }
        .error{ color:#ef4444; font-size:13px; margin-top:6px; display:none; }
        .note{ font-size:12px; color:#94a3b8; margin-top:6px; }
    </style>
</head>
<body>
<main class="card" aria-labelledby="signupTitle">
    <h1 id="signupTitle">회원가입</h1>
    <p class="lead">이메일, 비밀번호, (선택) 프로필 이미지, 닉네임을 입력해주세요.</p>

    <form id="signupForm" novalidate>
        <div class="field">
            <label for="email">이메일 <span style="color:#ef4444">*</span></label>
            <input id="email" name="email" type="email" required placeholder="you@example.com" />
            <div id="emailError" class="error">유효한 이메일 주소를 입력해주세요.</div>
        </div>

        <div class="field">
            <label for="password">비밀번호 <span style="color:#ef4444">*</span></label>
            <input id="password" name="password" type="password" required minlength="8" placeholder="최소 8자 이상" />
            <div class="pw-strength" aria-hidden="true"><i id="pwBar"></i></div>
            <div id="pwHint" class="small">영문, 숫자, 특수문자 조합을 권장합니다.</div>
            <div id="passwordError" class="error">비밀번호는 최소 8자 이상이어야 합니다.</div>
        </div>

        <div class="field">
            <label for="nickname">닉네임 <span style="color:#ef4444">*</span></label>
            <input id="nickname" name="nickname" type="text" required maxlength="30" placeholder="서비스에서 보여질 이름" />
            <div id="nickHint" class="small">중복은 서버에서 검사됩니다 — 고유한 닉네임을 권장합니다.</div>
            <div id="nicknameError" class="error">닉네임을 입력해주세요.</div>
        </div>

        <div class="field">
            <label for="image">프로필 이미지 (선택)</label>
            <input id="image" name="image" type="file" accept="image/*" />
            <div class="img-preview" id="imgPreview" style="display:none;">
                <img id="previewImage" alt="선택한 이미지 미리보기" />
                <div>
                    <div class="small" id="imgInfo"></div>
                    <button type="button" id="removeImage" style="margin-top:6px; padding:6px 8px; border-radius:6px; border:1px solid #e6eef8; background:white; cursor:pointer;">이미지 제거</button>
                </div>
            </div>
            <div class="note">이미지를 올리지 않으면 기본 아바타가 사용됩니다. (최대 5MB 권장)</div>
        </div>

        <div style="margin-top:12px;">
            <button class="btn" id="submitBtn" type="submit">가입하기</button>
        </div>

        <div id="submitMsg" class="small" style="margin-top:12px; display:none;"></div>
    </form>
</main>

<script>
    // 요소들
    const form = document.getElementById('signupForm');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const nickname = document.getElementById('nickname');
    const image = document.getElementById('image');
    const submitBtn = document.getElementById('submitBtn');

    const emailError = document.getElementById('emailError');
    const passwordError = document.getElementById('passwordError');
    const nicknameError = document.getElementById('nicknameError');
    const pwBar = document.getElementById('pwBar');
    const imgPreview = document.getElementById('imgPreview');
    const previewImage = document.getElementById('previewImage');
    const imgInfo = document.getElementById('imgInfo');
    const removeImageBtn = document.getElementById('removeImage');
    const submitMsg = document.getElementById('submitMsg');

    // 비밀번호 강도(단순)
    function passwordStrength(pw){
      let score = 0;
      if (pw.length >= 8) score += 1;
      if (/[A-Z]/.test(pw)) score += 1;
      if (/[0-9]/.test(pw)) score += 1;
      if (/[^A-Za-z0-9]/.test(pw)) score += 1;
      return score; // 0..4
    }

    password.addEventListener('input', () => {
      const s = passwordStrength(password.value);
      pwBar.style.width = (s / 4 * 100) + '%';
      passwordError.style.display = (password.value.length >= 8 ? 'none' : 'block');
    });

    // 이메일 기본 검증
    email.addEventListener('input', () => {
      const ok = email.checkValidity();
      emailError.style.display = ok ? 'none' : 'block';
    });

    nickname.addEventListener('input', () => {
      nicknameError.style.display = nickname.value.trim() ? 'none' : 'block';
    });

    // 이미지 미리보기
    image.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) { imgPreview.style.display = 'none'; return; }
      if (file.size > 5 * 1024 * 1024) {
        alert('이미지 크기는 5MB 이하로 권장합니다.');
      }
      const url = URL.createObjectURL(file);
      previewImage.src = url;
      imgInfo.textContent = `${file.name} · ${(file.size/1024|0)} KB`;
      imgPreview.style.display = 'flex';
    });

    removeImageBtn.addEventListener('click', () => {
      image.value = '';
      imgPreview.style.display = 'none';
      previewImage.src = '';
    });

    // 폼 제출
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      // 간단한 클라이언트 검증
      let valid = true;
      if (!email.checkValidity()) { emailError.style.display = 'block'; valid = false; }
      if (password.value.length < 8) { passwordError.style.display = 'block'; valid = false; }
      if (!nickname.value.trim()) { nicknameError.style.display = 'block'; valid = false; }

      if (!valid) return;

      submitBtn.disabled = true;
      submitMsg.style.display = 'block';
      submitMsg.textContent = '회원가입 요청 중입니다...';

      try {
        const fd = new FormData();
        fd.append('email', email.value.trim());
        fd.append('password', password.value); // 서버에서 해싱해야 합니다.
        fd.append('nickname', nickname.value.trim());
        if (image.files[0]) fd.append('image', image.files[0]);

        // 예시: multipart/form-data 로 전송
        const resp = await fetch('/api/v1/auth/signup', {
          method: 'POST',
          body: fd
        });

        if (resp.ok) {
          const data = await resp.json();
          submitMsg.style.color = 'green';
          submitMsg.textContent = '회원가입 완료되었습니다. 로그인 페이지로 이동합니다.';
          // 필요하면 리다이렉트
          // location.href = '/login';
        } else {
          // 서버에서 반환한 에러 메시지 표시 (가능하면 json)
          let text;
          try { text = await resp.json(); text = text.message || JSON.stringify(text); }
          catch(e){ text = await resp.text(); }
          submitMsg.style.color = '#dc2626';
          submitMsg.textContent = '오류: ' + (text || resp.statusText);
        }
      } catch (err) {
        submitMsg.style.color = '#dc2626';
        submitMsg.textContent = '네트워크 오류가 발생했습니다. 콘솔을 확인하세요.';
        console.error(err);
      } finally {
        submitBtn.disabled = false;
      }
    });
</script>
</body>
</html>
